<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../../../@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../../../@polymer/test-fixture/test-fixture.js"></script>
    <script src="../../../mocha/mocha.js"></script>
    <script src="../../../chai/chai.js"></script>
    <script src="../../../wct-mocha/wct-mocha.js"></script>

  </head>
  <body>

    <test-fixture id="NoAuto">
      <template>
        <websocket-panel no-auto></websocket-panel>
      </template>
    </test-fixture>

    <test-fixture id="Auto">
      <template>
        <websocket-panel></websocket-panel>
      </template>
    </test-fixture>

    <script type="module">
    import '../websocket-panel.js';
    import {DataGenerator} from '../../arc-data-generator/arc-data-generator.js';
    import sinon from '../../../sinon/pkg/sinon-esm.js';
    suite('Initialization', function() {
      let element;
      setup(function(done) {
        element = fixture('NoAuto');
        flush(() => done());
      });

      test('hasHistoryData is not computed', function() {
        assert.isUndefined(element.hasHistoryData);
      });

      test('websocket-data-view is not in the DOM', function() {
        assert.notOk(element.shadowRoot.querySelector('websocket-data-view'));
      });

      test('websocket-data-view is in the DOM when messages are set', function(done) {
        element.messages = DataGenerator.generateUrlsData({
          size: 4
        });
        flush(() => {
          const node = element.shadowRoot.querySelector('websocket-data-view');
          assert.ok(node);
          done();
        });
      });

      test('websocket-history is hidden when connecting', function(done) {
        element.connecting = true;
        flush(() => {
          const node = element.shadowRoot.querySelector('websocket-history');
          const display = getComputedStyle(node).display;
          assert.equal(display, 'none');
          done();
        });
      });

      test('websocket-history is hidden when connected', function(done) {
        element.connected = true;
        flush(() => {
          const node = element.shadowRoot.querySelector('websocket-history');
          const display = getComputedStyle(node).display;
          assert.equal(display, 'none');
          done();
        });
      });
    });

    suite('_dispatchHistoryList()', () => {
      let element;
      setup(function() {
        element = fixture('NoAuto');
      });

      test('Dispatches websocket-url-history-list event', () => {
        const spy = sinon.spy();
        element.addEventListener('websocket-url-history-list', spy);
        element._dispatchHistoryList();
        assert.isTrue(spy.called);
      });

      test('Returns the event', () => {
        const result = element._dispatchHistoryList();
        assert.typeOf(result, 'customevent');
      });

      test('Event is cancelable', () => {
        const e = element._dispatchHistoryList();
        assert.isTrue(e.cancelable);
      });

      test('Event bubbles', () => {
        const e = element._dispatchHistoryList();
        assert.isTrue(e.bubbles);
      });

      test('Event has empty detail object', () => {
        const e = element._dispatchHistoryList();
        assert.deepEqual(e.detail, {});
      });
    });

    suite('refreshHistory()', () => {
      let element;
      setup(function() {
        element = fixture('NoAuto');
      });

      function handler(e) {
        e.preventDefault();
        e.detail.result = Promise.resolve(DataGenerator.generateUrlsData({
          size: 4
        }));
      }

      function errorHandler(e) {
        e.preventDefault();
        e.detail.result = Promise.reject(new Error('test'));
      }

      teardown(() => {
        window.removeEventListener('websocket-url-history-list', handler);
        window.removeEventListener('websocket-url-history-list', errorHandler);
      });

      test('Calls _dispatchHistoryList()', () => {
        window.addEventListener('websocket-url-history-list', handler);
        const spy = sinon.spy(element, '_dispatchHistoryList');
        element.refreshHistory();
        assert.isTrue(spy.called);
      });

      test('Sets loading flag', () => {
        window.addEventListener('websocket-url-history-list', handler);
        element.refreshHistory();
        assert.isTrue(element.loading);
      });

      test('Sets history when ready', () => {
        window.addEventListener('websocket-url-history-list', handler);
        return element.refreshHistory()
        .then(() => {
          assert.typeOf(element.history, 'array');
          assert.lengthOf(element.history, 4);
        });
      });

      test('Resets loading flag', () => {
        window.addEventListener('websocket-url-history-list', handler);
        return element.refreshHistory()
        .then(() => {
          assert.isFalse(element.loading);
        });
      });

      test('Resets loading flag when error', () => {
        window.addEventListener('websocket-url-history-list', errorHandler);
        return element.refreshHistory()
        .then(() => {
          assert.isFalse(element.loading);
        });
      });

      test('Throws when event not handled', () => {
        assert.throws(() => {
          element.refreshHistory();
        });
      });
    });

    suite('_storeItemChanged()', () => {
      let element;
      setup(function() {
        element = fixture('NoAuto');
      });

      function fire(item, cancelable) {
        const e = new CustomEvent('websocket-url-history-changed', {
          bubbles: true,
          cancelable,
          detail: {
            item
          }
        });
        document.body.dispatchEvent(e);
      }

      test('Creates history array', () => {
        const item = DataGenerator.generateUrlsData({
          size: 1
        })[0];
        fire(item);
        assert.typeOf(element.history, 'array');
        assert.lengthOf(element.history, 1);
      });

      test('Appends to history array', () => {
        element.history = DataGenerator.generateUrlsData({
          size: 1
        });
        const item = DataGenerator.generateUrlsData({
          size: 1
        })[0];
        fire(item);
        assert.typeOf(element.history, 'array');
        assert.lengthOf(element.history, 2);
      });

      test('Updates history', () => {
        element.history = DataGenerator.generateUrlsData({
          size: 2
        });
        const item = Object.assign({}, element.history[0]);
        item.testValue = true;
        fire(item);
        assert.typeOf(element.history, 'array');
        assert.lengthOf(element.history, 2);
        assert.isTrue(element.history[0].testValue);
      });

      test('Ignores cancelable events', () => {
        const item = DataGenerator.generateUrlsData({
          size: 1
        })[0];
        fire(item, true);
        assert.isUndefined(element.history);
      });
    });

    suite('_computeHasHistoryData()', () => {
      let element;
      setup(function() {
        element = fixture('NoAuto');
      });

      test('Returns false if no argument', () => {
        const result = element._computeHasHistoryData();
        assert.isFalse(result);
      });

      test('Returns false if argument is empty array', () => {
        const result = element._computeHasHistoryData([]);
        assert.isFalse(result);
      });

      test('Returns true if argument is not empty array', () => {
        const result = element._computeHasHistoryData([{}]);
        assert.isTrue(result);
      });
    });

    suite('_clearMessages()', () => {
      let element;
      setup(function() {
        element = fixture('NoAuto');
        element.mesages = [{}];
      });

      test('Clear messages', () => {
        element._clearMessages();
        assert.isUndefined(element.messages);
      });
    });

    suite('Auto query', () => {
      test('Queries for data when added to the DOM', () => {
        let called = false;
        window.addEventListener('websocket-url-history-list', function f(e) {
          window.removeEventListener('websocket-url-history-list', f);
          called = true;
          e.preventDefault();
          e.detail.result = Promise.resolve(DataGenerator.generateUrlsData({
            size: 4
          }));
        });
        fixture('Auto');
        assert.isTrue(called);
      });
    });
    </script>

  </body>
</html>
